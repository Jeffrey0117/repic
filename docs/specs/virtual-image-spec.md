# Virtual Image (.repic) Specification

## Overview

虛擬圖片 (.repic) 是 Repic 的核心功能，讓用戶能用極小的檔案空間管理網路圖片。本文件定義虛擬圖片與真實圖片之間的連動規格。

---

## 現有功能

- [x] 儲存 URL + metadata 到 .repic 檔案
- [x] 在 viewer 中顯示網路圖片
- [x] 導航瀏覽同資料夾的 .repic 檔案
- [x] 匯出/下載成真實圖片

---

## 規劃中功能

### 1. 本機圖片轉虛擬圖

**觸發方式：** TopBar「轉為虛擬圖」按鈕（僅本機圖片模式顯示）

**流程：**
```
1. 用戶正在檢視本機圖片
2. 點擊 TopBar「轉為虛擬圖」按鈕
3. 彈出確認對話框：
   「確定要將此圖片轉為虛擬圖嗎？
    圖片將上傳至圖床，本機檔案將被刪除。」
   [取消] [確定轉換]
4. 確認後：
   - 顯示上傳進度
   - 上傳圖片到圖床（urusai.cc）
5. 上傳成功：
   - 建立 .repic 檔案（同檔名，同位置）
   - 刪除原本的本機圖片
   - Toast：「已轉為虛擬圖」
   - 自動切換到新的 .repic 檔案
6. 上傳失敗：
   - 保留原檔不動
   - Toast：「轉換失敗：{錯誤訊息}」
```

**UI 狀態：**
- 按鈕僅在 viewMode === 'local' 且有本機圖片時顯示
- 上傳中按鈕顯示 loading 狀態，禁止重複點擊

---

### 2. 發到社群

**使用場景：**
用戶想把虛擬圖發到 IG/Twitter/Discord 等社群平台

#### 2.1 複製到剪貼簿（確定實作）

```
觸發：TopBar「複製」按鈕
流程：
1. 下載圖片到記憶體
2. 複製到系統剪貼簿
3. Toast 提示「已複製」
4. 用戶到社群 Ctrl+V 貼上
```

- 無暫存檔，記憶體自動釋放
- 真實圖片和虛擬圖片都支援

#### 2.2 拖曳到其他 App（確定實作）

```
觸發：從 Sidebar 縮圖或中間大圖拖曳
流程：
1. 拖曳開始 → 下載圖片到暫存資料夾
2. 傳遞暫存檔給目標 App
3. 暫存檔定時清理（1 小時後）
```

**暫存位置：** `%TEMP%/repic/`

**清理策略：**
- 每個暫存檔建立 1 小時後自動刪除
- App 啟動時清理過期檔案

**拖曳來源：**
- [x] Sidebar 縮圖
- [x] 中間大圖區域

#### 2.3 檔案總管拖曳（Phase 2）

需要 Windows Shell Extension，暫不實作。未來可考慮：
- 從檔案總管拖 .repic 時自動下載並替換
- 右鍵選單加「複製圖片」

---

### 3. 虛擬圖裁切

**方案：** 記錄裁切參數到 .repic 檔案（非破壞性編輯）

**.repic 檔案格式擴充：**
```json
{
  "url": "https://example.com/image.jpg",
  "name": "my-image",
  "addedAt": 1706000000000,
  "crop": {
    "x": 10,
    "y": 20,
    "width": 80,
    "height": 60
  }
}
```

- `crop` 欄位可選，使用百分比座標
- 原圖 URL 不變，只記錄裁切範圍

**裁切應用時機：**
- 檢視時：顯示裁切後的畫面
- 下載時：輸出裁切後的圖片
- 複製到剪貼簿時：複製裁切後的圖片
- 拖曳時：傳遞裁切後的圖片
- Sidebar 縮圖：顯示裁切後的預覽

**重置裁切：**
- 提供「重置」選項，清除 crop 參數恢復原圖

---

### 4. 統一操作體驗

| 功能 | 真實圖片 | 虛擬圖片 | 狀態 |
|------|---------|---------|------|
| 檢視 | ✅ | ✅ | 完成 |
| 裁切 | ✅ 破壞性 | ✅ 非破壞性（參數） | 待實作 |
| 上傳到圖床 | ✅ | ❌ 不需要 | - |
| 下載/匯出 | ❌ 不需要 | ✅ | 完成 |
| Sidebar 縮圖 | ✅ | ✅ | 完成 |
| 檔案總管縮圖 | ✅ (系統原生) | ❌ Phase 2 | - |
| 拖曳到其他 App | ✅ | ✅ | 待實作 |
| 複製到剪貼簿 | ✅ | ✅ | 待實作 |
| 轉為虛擬圖 | ✅ 待實作 | ❌ 已經是 | - |

---

## 討論紀錄

### 2025-01-25

- 確認「轉為虛擬圖」會刪除本機圖片
- 發到社群：複製到剪貼簿 + App 內拖曳
- 虛擬圖裁切：非破壞性，記錄參數
- 暫存清理：1 小時後自動刪除
- 轉虛擬圖按鈕放 TopBar，需二次確認
- 檔案總管縮圖/拖曳：Phase 2

---

## 實作優先順序

### Phase 1（核心功能）
1. [x] TopBar「複製到剪貼簿」按鈕 ✅
2. [x] App 內拖曳（Sidebar + 大圖） ✅
3. [x] 暫存管理 + 清理機制 ✅
4. [x] 虛擬圖裁切（參數記錄） ✅
   - 裁切參數存到 album metadata
   - 顯示時用 clip-path 套用
   - 複製時用 canvas 裁切
   - 拖曳時套用 crop（待完成）
5. [ ] 本機圖轉虛擬圖

### Phase 2（進階功能）
- [ ] 檔案總管 Shell Extension（縮圖 + 拖曳）
- [ ] 右鍵選單「複製圖片」

---

## 已決定事項

- [x] 發到社群方案：複製 + 拖曳
- [x] 虛擬圖裁切：非破壞性參數
- [x] 暫存清理：1 小時
- [x] 轉虛擬圖：TopBar + 二次確認
- [x] 檔案總管功能：Phase 2
